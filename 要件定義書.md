# WordPressマルシェ顧客管理システム - 出店者募集機能 要件定義書

## 📋 プロジェクト概要

### プロジェクト名
WordPressマルシェ顧客管理システム - 出店者募集機能

### 目的
WordPressを使用したマルシェの出店者募集システムを構築し、出店申込から決済、承認までの一連のプロセスを自動化する。

### 対象ユーザー
- **出店者**: マルシェへの出店を希望する個人・法人
- **管理者**: マルシェ運営者、システム管理者
- **一般ユーザー**: 出展者一覧を閲覧する来場者

## 🎯 機能要件

### 1. 出店申込機能

#### 1.1 基本申込フォーム ✅ 完了
- **必須項目**
  - 出展者名（個人名または法人名）
  - 連絡先情報（メールアドレス、電話番号）
  - 商品・サービス内容の説明
  - 出店エリアの選択
  - レンタル用品の選択
  - チラシ画像のアップロード

- **任意項目**
  - SNSアカウント情報
  - 特記事項
  - 過去の出店経験

#### 1.2 動的料金計算機能 ✅ 完了
- **エリア別料金**
  - 動的エリア管理（追加・編集・削除可能）
  - フォームID＋開催日ごとの独立したエリア・料金・定員設定
  - 各エリアの定員数制限（開催日ごとに個別設定）
  - 定員状況に応じた選択肢の制御（開催日ごとに判定）

- **レンタル用品料金**
  - 動的レンタル用品管理（追加・編集・削除可能）
  - フォームID毎の独立した料金設定
  - 数量による料金計算
  - 在庫状況の確認

#### 1.3 動的選択肢生成機能 ✅ 完了
- **Contact Form 7フック連携**
  - wpcf7_form_tag_data_optionフックによる動的選択肢生成
  - 管理画面での設定変更の即座反映
  - 定員状況に応じた選択肢の制御（満員表示）
- **開催日選択肢**
  - 管理画面で追加・編集した開催日の動的表示
  - 開催日・曜日・説明の個別設定
  - 開催日の有効/無効設定
  - ソート順の管理
- **エリア選択肢（booth-location）**
  - 管理画面で追加・編集したエリアの動的表示
  - 料金・定員・説明の個別設定
  - ソート順の管理
  - 既存フィールドとの互換性維持
- **レンタル用品選択肢（rental-tent, rental-table, rental-chair）**
  - 管理画面で追加・編集した用品の動的表示
  - 料金・単位・説明の個別設定
  - 既存フィールドとの互換性維持
  - 数量フィールドの動的生成
  - 最小・最大数量設定機能

#### 1.4 画像アップロード機能（実装予定）
- **対応画像**
  - 出展者一覧用チラシ画像
  - 商品サンプル画像
  - 店舗ロゴ
  - 食品衛生許可証（食品の場合）

- **画像制限**
  - ファイルサイズ: 最大15MB（Contact Form 7側で制限）
  - 対応形式: JPG, PNG, GIF（Contact Form 7側で制限）
  - 必須/任意の設定

- **画像保存機能**
  - 永続的な画像保存（wp-content/uploads/marche/）
  - 開催日・申し込み者名別のディレクトリ構造
  - セキュアなファイル名生成
  - メールでの画像URL送信

### 2. 決済機能

#### 2.1 決済方法選択
- **対応決済方法**
  - クレジットカード決済（Stripe）
  - 銀行振込み
- **決済方法設定**: フォームごとに選択可能
- **決済タイミング**: 申込フォーム送信時

#### 2.2 クレジットカード決済
- **決済システム**: Stripe（Contact Form 7連携）
- **決済金額**: 動的計算された合計金額
- **決済完了**: 自動承認処理
- **設定**: Contact Form 7の管理画面で設定

#### 2.3 銀行振込み
- **振込み案内**: Contact Form 7の自動返信メール
- **振込み確認**: 手動確認による承認
- **設定**: Contact Form 7の管理画面で設定

#### 2.4 決済管理
- 決済状況の確認
- 決済履歴の管理
- 返金処理（必要に応じて）
- 未決済申込の管理

### 3. 会員登録機能

#### 3.1 自動会員登録
- **登録タイミング**: 出店申込と同時
- **権限設定**: WordPress購読者権限
- **登録情報**: 申込フォームの情報を基に自動生成

#### 3.2 会員機能
- 出店履歴の確認
- プロフィール編集
- 通知設定

### 4. 出展者一覧表示機能

#### 4.1 公開一覧
- 承認済み出展者の表示
- チラシ画像の表示
- 商品・サービス内容の表示
- 出店エリアの表示

#### 4.2 表示方法
- グリッド表示
- リスト表示
- 検索・フィルター機能

### 5. 管理機能

#### 5.1 プラグイン管理画面 ✅ 完了
- **フォーム管理**
  - フォーム一覧表示
  - フォーム追加・編集・削除
  - フォーム設定の複製機能
  - 設定比較機能
  - **フォームタイプ分類機能**（新規追加予定）
    - マルシェ・ステージの選択機能
    - タイプ別フォーム管理
    - タイプ別設定の継承
- **設定管理**
  - フォームIDごとの設定
  - 動的開催日管理（追加・編集・削除）
  - 動的エリア管理（追加・編集・削除）
  - 動的レンタル用品管理（追加・編集・削除）
  - 定員設定の管理
  - 支払い方法選択の管理
  - ファイル設定の管理
- **Contact Form 7連携**
  - 動的選択肢の自動生成
  - 設定変更の即座反映
  - 連携状況の監視
  - 設定のインポート/エクスポート機能

#### 5.2 ダッシュボード機能（実装予定）
- **統計情報表示**
  - エリア別申し込み数表示（上部左側の箱）
  - レンタル用品別数量表示（上部中央の箱）
  - チラシ枚数合計表示（上部右側の箱）
  - ロールーフ車両数表示（上部右側の箱）
  - ハイルーフ車両数表示（上部右側の箱）
- **申し込み一覧表示**
  - 選択開催日の申し込みデータ一覧表示
  - テーブル形式での詳細表示
  - ソート・検索・フィルター機能
- **データ集計機能**
  - エリア別集計（管理画面で登録されたエリアごと）
  - レンタル用品別集計（管理画面で登録された用品ごと）
  - チラシ枚数合計（flyer-numberフィールドの合計）
  - 車両タイプ判定（booth-car-height値による判定）
    - ロールーフ：1550以下
    - ハイルーフ：1550より上

#### 5.3 画像管理機能（実装予定）
- **画像管理メニュー**
  - サブメニュー「画像管理」追加
  - 画像一覧表示画面
  - フォーム・開催日別フィルター
- **画像詳細表示**
  - 画像情報表示
  - 関連申し込み情報表示
  - 画像ダウンロード機能

#### 5.4 申込管理
- 申込状況一覧の表示
- 決済状況の確認
- エリア使用状況の管理
- レンタル用品在庫の管理
- 決済方法別の申込管理

#### 5.5 承認プロセス
- クレジットカード決済: 決済完了時の自動承認
- 銀行振込み: 振込み確認後の手動承認
- 手動承認/却下機能
- 承認後の通知機能

#### 5.6 レポート機能
- 出店申込統計
- 売上レポート
- エリア使用率レポート
- 決済方法別統計
- 設定変更履歴

## 🔧 技術要件

### 1. システム構成

#### 1.1 基本構成
- **CMS**: WordPress 6.7以降
- **PHP**: 7.4以降
- **データベース**: MySQL 5.7以降

#### 1.2 主要プラグイン
- **Contact Form 7**: バージョン6.1（最新版）
  - 基本フォーム作成
  - 条件分岐機能
  - ファイルアップロード機能
  - Stripe連携機能

#### 1.3 カスタム実装 ✅ 完了
- 料金計算機能
- ユーザー登録連携
- 出展者一覧表示
- 管理画面機能
- プラグイン管理機能

#### 1.4 管理プラグイン ✅ 完了
- **Marche Management Plugin**
  - フォームIDごとの設定管理
  - 動的開催日管理（追加・編集・削除）
  - 動的エリア管理（追加・編集・削除）
  - 動的レンタル用品管理（追加・編集・削除）
  - 定員設定の管理画面
  - 支払い方法選択の管理画面
  - ファイル設定の管理画面
  - Contact Form 7フック連携機能
  - 設定のインポート/エクスポート機能
  - 設定比較・コピー機能

#### 1.5 データベース設計 ✅ 完了
- **wp_marche_forms**: フォーム基本設定
- **wp_marche_dates**: 開催日管理
- **wp_marche_areas**: エリア管理
- **wp_marche_rental_items**: レンタル用品管理
- **wp_marche_applications**: 申込管理（将来拡張用）
- **wp_marche_applications**: 申し込みデータ保存（実装予定）
- **wp_marche_files**: ファイル情報保存（実装予定）

#### 1.6 フィールド名命名規則 ✅ 完了
- **開催日選択**: `date`（新規追加）
- **エリア選択**: `booth-location`（既存フィールド）
- **レンタル用品**: 管理画面で自由設定（例: `rental-tent`, `rental-table`, `rental-chair`）
- **その他既存フィールド**: フォームごとに設定可能（例: `booth-name`, `booth-summary`, `booth-detail`, `booth-generator`, `booth-carrying`, `booth-car-type`, `booth-car-height`, `your-name`, `your-company`, `your-email`, `your-tel`, `your-address`, `flyer-image`, `flyer-desired`, `flyer-number`, `flyer-zip`, `flyer-address`, `other-know`, `other-remarks`, `other-terms`）

#### 1.7 申し込みデータ保存設定（実装予定）
- **必須保存項目**:
  - `form_id`: フォームID
  - `date_id`: 開催日ID
  - `booth-location`: エリア名
  - `flyer-number`: チラシ枚数
  - `booth-car-height`: 車両高さ（ロールーフ/ハイルーフ判定用）
- **柔軟保存項目**: Contact Form 7の全送信データをJSON形式で保存
- **レンタル用品**: 管理画面で登録されたレンタル用品の選択データを抽出・保存

#### 1.7.1 設定
- Contact Form 7のフォームに含めないといけない項目の確認
  - `your-name`: 顧客名（必須）
  - `your-email`: メールアドレス（必須）
  - `date`: 開催日選択（必須）
  - `booth-location`: エリア選択（必須）
  - `rental-*`: レンタル用品数量（任意）
  - `flyer-number`: チラシ枚数（ダッシュボード統計用）
  - `booth-car-height`: 車両高さ（ダッシュボード統計用）

#### 1.8 ファイル管理設定（実装予定）
- **画像保存構造**:
  - ベースディレクトリ: `wp-content/uploads/marche/`
  - 開催日別ディレクトリ: `開催日(date)/`
  - 申し込み者別ディレクトリ: `名前(your-name)_連番/`
- **ファイル命名規則**:
  - タイムスタンプ付きファイル名
  - セキュアなファイル名生成
- **メール送信機能**:
  - [_file_urls]メールタグの実装
  - アップロード画像のURL一覧生成
  - メール本文への画像URL挿入

### 2. セキュリティ要件

#### 2.1 データ保護
- 個人情報の暗号化
- 決済情報のセキュア処理
- ファイルアップロードのセキュリティ

#### 2.2 アクセス制御
- 管理者権限の適切な設定
- 一般ユーザーと出店者の権限分離
- セッション管理

#### 2.3 スパム対策
- reCAPTCHA連携
- Akismet連携
- カスタムバリデーション

### 3. パフォーマンス要件

#### 3.1 レスポンス時間
- フォーム送信: 5秒以内
- 画像アップロード: 30秒以内
- ページ表示: 3秒以内

#### 3.2 同時接続数
- 最大100ユーザーの同時アクセス

#### 3.3 ストレージ
- 画像保存容量: 1GB以上
- データベース容量: 適切な設計

### 4. データベース設計詳細 ✅ 完了

#### 4.1 wp_marche_forms（フォーム基本設定）
```sql
CREATE TABLE wp_marche_forms (
    id INT AUTO_INCREMENT PRIMARY KEY,
    form_id INT NOT NULL UNIQUE, -- Contact Form 7のフォームID
    form_name VARCHAR(255) NOT NULL,
    form_type ENUM('マルシェ', 'ステージ') DEFAULT 'マルシェ', -- フォームタイプ分類
    payment_method ENUM('credit_card', 'bank_transfer', 'both') DEFAULT 'both',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 4.2 wp_marche_dates（開催日管理）
```sql
CREATE TABLE wp_marche_dates (
    id INT AUTO_INCREMENT PRIMARY KEY,
    form_id INT NOT NULL,
    date_value DATE NOT NULL,
    description VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (form_id) REFERENCES wp_marche_forms(id) ON DELETE CASCADE
);
```

#### 4.3 wp_marche_areas（エリア管理）
```sql
CREATE TABLE wp_marche_areas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    form_id INT NOT NULL,
    area_name VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    capacity INT DEFAULT 0, -- 0=無制限
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (form_id) REFERENCES wp_marche_forms(id) ON DELETE CASCADE
);
```

#### 4.4 wp_marche_rental_items（レンタル用品管理）
```sql
CREATE TABLE wp_marche_rental_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    form_id INT NOT NULL,
    item_name VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    unit VARCHAR(50) NOT NULL, -- "個", "セット", "枚"
    min_quantity INT DEFAULT 0,
    max_quantity INT DEFAULT 0, -- 0=無制限
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (form_id) REFERENCES wp_marche_forms(id) ON DELETE CASCADE
);
```

#### 4.5 wp_marche_applications（申し込みデータ保存）
```sql
CREATE TABLE wp_marche_applications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    form_id INT NOT NULL,
    date_id INT NOT NULL,
    application_data JSON NOT NULL, -- Contact Form 7の送信データをJSON形式で保存
    area_name VARCHAR(255), -- 選択されたエリア名（必須）
    flyer_number INT DEFAULT 0, -- チラシ枚数（必須）
    car_height VARCHAR(50), -- 車両高さ（ロールーフ/ハイルーフ判定用）（必須）
    rental_items JSON, -- レンタル用品選択データ（JSON形式）
    files_json JSON, -- ファイル情報（JSON形式）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (form_id) REFERENCES wp_marche_forms(id) ON DELETE CASCADE,
    FOREIGN KEY (date_id) REFERENCES wp_marche_dates(id) ON DELETE CASCADE,
    INDEX idx_form_date (form_id, date_id),
    INDEX idx_created_at (created_at)
);
```

#### 4.6 wp_marche_files（ファイル情報保存）
```sql
CREATE TABLE wp_marche_files (
    id INT AUTO_INCREMENT PRIMARY KEY,
    application_id INT NOT NULL,
    file_name VARCHAR(255) NOT NULL, -- オリジナルファイル名
    file_path VARCHAR(500) NOT NULL, -- 保存先パス
    file_url VARCHAR(500) NOT NULL, -- アクセス用URL
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (application_id) REFERENCES wp_marche_applications(id) ON DELETE CASCADE,
    INDEX idx_application_id (application_id),
    INDEX idx_uploaded_at (uploaded_at)
);
```

## 📊 非機能要件

### 1. 可用性
- システム稼働率: 99%以上
- メンテナンス時間: 月1回、深夜2時間以内

### 2. 拡張性
- 将来的な機能追加への対応
- ユーザー数の増加への対応
- エリア・料金体系の変更への対応

### 3. 保守性
- コードの可読性確保
- 適切なコメント・ドキュメント
- バックアップ・復旧機能

## 🚀 実装計画

### ✅ Phase 1: プラグイン基本構築（完了）
1. Marche Management Plugin作成
2. 管理画面メニュー構築
3. データベース設計
4. 基本設定画面実装

### ✅ Phase 2: 動的管理機能実装（完了）
1. 動的開催日管理画面実装
2. 動的エリア管理画面実装
3. 動的レンタル用品管理画面実装
4. Contact Form 7フック連携実装
5. 定員設定画面実装
6. 既存functions.phpとの連携
7. 料金計算ロジック更新
8. Contact Form 7用コード表示機能

### 🔄 Phase 2.5: 申し込みデータ管理機能実装（実装予定）
1. 申し込みデータ保存機能実装
2. Contact Form 7送信完了時のデータ自動保存
3. ダッシュボード機能実装
4. 統計情報表示機能
5. 申し込み一覧表示機能

### 🔄 Phase 2.6: ファイル管理機能実装（実装予定）
1. 画像保存機能実装
2. Contact Form 7統合
3. 管理画面画像管理機能
4. メール送信機能

## ⚠️ 注意事項・制約

### 1. 技術的制約
- Contact Form 7の最新版（6.1）を使用
- WordPress 6.7以降の対応
- PHP 7.4以降の対応
- ES2024準拠JavaScript（jQuery完全排除）
- HTML5 Drag and Drop API使用

### 2. セキュリティ注意事項
- ファイルアップロードの適切な制限設定
- 決済情報の適切な処理
- 個人情報の保護

### 3. 運用注意事項
- 定期的なバックアップ
- セキュリティアップデートの適用
- パフォーマンス監視

## 📝 実装完了状況

### ✅ 完了済み機能
1. **プラグイン基本構築**
   - プラグインファイル構造
   - 管理画面メニュー構築
   - データベース設計・実装
   - 基本設定画面実装
   - フォームタイプ分類機能

2. **動的管理機能**
   - 動的開催日管理画面
   - 動的エリア管理画面
   - 動的レンタル用品管理画面
   - Contact Form 7フック連携
   - ドラッグ&ドロップ並び順変更機能
   - 定員制限機能
   - 料金計算機能

3. **申し込みデータ管理**
   - 申し込みデータ保存機能
   - Contact Form 7送信完了時のデータ自動保存
   - ダッシュボード機能
   - 統計情報表示機能
   - 申し込み一覧表示機能
   - ファイル管理機能

4. **Stripe決済連携**
   - 料金計算機能
   - Contact Form 7 Stripe連携
   - 動的決済金額設定
   - 決済情報の動的生成

5. **技術実装**
   - ES2024準拠のバニラJavaScript
   - HTML5 Drag and Drop API
   - jQuery完全排除
   - 日本語UI対応

---

**作成日**: 2025年1月
**更新日**: 2025年1月
