# WordPressマルシェ顧客管理システム - 実装チェックリスト

## 📋 プロジェクト概要

### プロジェクト名
WordPressマルシェ顧客管理システム - 出店者募集機能

### 目的
Marche Management Pluginの実装を通じて、Contact Form 7と連携した動的なフォーム作成管理システムを構築する。

### 技術スタック
- **WordPress**: 6.7以降
- **PHP**: 7.4以降
- **MySQL**: 5.7以降
- **Contact Form 7**: 6.1以降

---

## 🚀 Phase 1: プラグイン基本構築（2週間）

### 1.1 プラグインファイル構造
- [x] プラグインのメインファイル作成（marche-management-plugin.php）
- [x] プラグイン情報の設定（Plugin Header）
- [x] アクティベーション・デアクティベーション処理
- [x] アンインストール処理
- [x] 必要なディレクトリ構造の作成
  - [x] includes/
  - [x] admin/
  - [x] assets/
  - [x] languages/（日本語のみ対応のため不要）

### 1.2 管理画面メニュー構築
- [x] WordPress管理画面へのメニュー追加
- [x] サブメニューの作成
  - [x] フォーム管理
  - [x] 開催日管理
  - [x] エリア管理
  - [x] レンタル用品管理
  - [x] ダッシュボード
  - [x] 設定

### 1.3 データベース設計・実装
- [x] データベーステーブル作成処理
  - [x] wp_marche_forms
  - [x] wp_marche_dates
  - [x] wp_marche_areas
  - [x] wp_marche_rental_items
  - [x] wp_marche_applications（申し込みデータ保存用）
- [x] テーブル作成SQLの実装
- [x] 外部キー制約の設定（KEYインデックス）
- [x] インデックスの設定

### 1.4 基本設定画面実装
- [x] フォーム一覧表示画面
- [x] フォーム追加・編集画面
- [x] フォーム削除機能
- [x] 基本設定の保存・読み込み機能

### 1.5 フォームタイプ分類機能実装
- [x] フォームタイプ選択機能（マルシェ・ステージ）
- [x] データベーススキーマ拡張（form_typeカラム追加）
- [x] フォーム管理画面にタイプ選択UI追加
- [x] 既存データベースのマイグレーション処理
- [x] フォームタイプ別の表示・管理機能

---

## 🔧 Phase 2: 動的管理機能実装（3週間）

### 2.1 動的開催日管理画面実装
- [x] 開催日一覧表示
- [x] 開催日追加・編集・削除機能
- [x] 開催日の有効/無効切り替え
- [x] 開催日のソート順管理
- [x] 開催日の説明文管理
- [x] フォームIDとの関連付け

### 2.2 動的エリア管理画面実装
- [x] エリア一覧表示（開催日ごとに切り替え可能）
- [x] エリア追加・編集・削除機能（開催日ごとに管理）
- [x] エリアの料金設定（開催日ごとに個別設定）
- [x] エリアの定員設定（開催日ごとに個別設定）
- [x] エリアの有効/無効切り替え（開催日ごとに管理）
- [x] エリアのソート順管理（開催日ごとに管理）
- [x] フォームID＋開催日ごとの関連付け
- [x] 定員オーバー時の処理（開催日ごとにフォーム送信制限）
- [x] 定員制限の有効/無効設定（開催日ごとに管理）

### 2.3 動的レンタル用品管理画面実装
- [x] レンタル用品一覧表示
- [x] レンタル用品追加・編集・削除機能
- [x] レンタル用品の料金設定
- [x] レンタル用品の単位設定
- [x] レンタル用品の有効/無効切り替え
- [x] レンタル用品のソート順管理
- [x] フォームIDとの関連付け
- [x] レンタル用品の最小・最大数量設定機能
- [x] 数量制限のバリデーション機能

### 2.4 Contact Form 7フック連携実装
- [x] wpcf7_form_tag_data_optionフックの実装（開催日・エリア選択肢用）
- [x] 動的選択肢生成機能
  - [x] 開催日選択肢（date）
  - [x] エリア選択肢（booth-location）
- [x] 定員状況に応じた選択肢制御
- [x] 既存フィールドとの互換性確保
- [x] レンタル用品数量フィールド対応
  - [x] wpcf7_form_tag フックの実装（数量フィールド動的生成用）
  - [x] レンタル用品別の最小・最大値設定機能
  - [x] 数量フィールドの動的生成（rental-プレフィックス付きの自由設定フィールド）
  - [x] レンタル用品管理画面での最小・最大値設定UI追加

### 2.5 Contact Form 7用コード表示機能
- [x] 開催日管理画面にコード表示機能追加
- [x] エリア管理画面にコード表示機能追加
- [x] レンタル用品管理画面にコード表示機能追加
- [x] フォーム管理画面にコード表示機能追加
- [x] コピーボタン機能実装
- [x] 各フィールドの説明文追加

### 2.6 料金計算ロジック更新
- [x] 動的料金計算機能
- [x] エリア別料金計算
- [x] レンタル用品数量別料金計算
- [x] 合計金額の動的更新
- [x] 数量制限チェック機能

### 2.7 既存functions.phpとの連携
- [x] 既存の料金計算ロジックとの統合
- [x] 既存のJavaScript連携
- [x] 既存のStripe連携との調整

### 2.8 申し込みデータ保存機能
- [x] 申し込みデータ保存用テーブル作成（wp_marche_applications）
- [x] Contact Form 7送信完了時のデータ自動保存機能
- [x] 申し込みデータの構造設計
  - [x] 必須項目の設定（フォームID、開催日ID、エリア名、チラシ枚数、車両高さ）
  - [x] 柔軟なデータ保存構造（JSON形式での全フォームデータ保存）
  - [x] レンタル用品選択情報の抽出・保存

#### 2.8.1 設定
- [x] Contact Form 7のフォームに含めないといけない項目の確認
  - [x] `your-name`: 顧客名（必須）
  - [x] `your-email`: メールアドレス（必須）
  - [x] `date`: 開催日選択（必須）
  - [x] `booth-location`: エリア選択（必須）
  - [x] `booth-car-height`: 車両高さ（ダッシュボード統計用・必須）
  - [x] `booth-carrying`: 車両積載量（ダッシュボード統計用・必須）
  - [x] `flyer-number`: チラシ枚数（ダッシュボード統計用・必須）
  - [x] `rental-*`: レンタル用品数量（任意）

### 2.9 ダッシュボード機能実装

#### 2.9.1 ダッシュボード管理画面の作成
- [x] ダッシュボード管理画面の作成
- [x] フォーム選択機能（既存システムと同様）
- [x] 開催日選択機能（動的エリア管理画面と同様）

#### 2.9.2 統計情報表示機能
- [x] 統計情報表示機能
- [x] エリア別申し込み数表示機能
- [x] レンタル用品別数量表示機能
- [x] チラシ枚数合計表示機能
- [x] 車両タイプ別集計表示機能（ロールーフ・ハイルーフ）

#### 2.9.3 申し込み一覧表示機能
- [x] 申し込み一覧表示機能
- [x] 開催日別フィルター機能
- [x] データテーブル表示機能
- [x] ファイル情報表示機能

#### 2.9.4 申し込み一覧並び替え機能
- [x] 並び替え可能な列の設定
  - [x] エリア名（booth-location）での並び替え
  - [x] チラシ枚数（flyer-number）での並び替え
  - [x] 車で搬入希望（booth-carrying）での並び替え
- [x] 並び替え方向の切り替え（昇順・降順）
- [x] 現在の並び替え状態の視覚的表示
  - [x] 並び替え可能な列に矢印アイコン表示
  - [x] 現在の並び替え列と方向のハイライト
- [x] URLパラメータでの並び替え状態保持
- [x] 並び替え状態のセッション保存
- [x] レスポンシブ対応（モバイルでの並び替え表示）

#### 2.9.5 列設定管理機能
- [x] 動的列生成機能
- [x] 列設定保存機能
- [x] 列表示/非表示切り替え機能

#### 2.9.6 ファイル管理統合
- [x] ファイル情報表示機能
- [x] 画像プレビュー機能（Ajax表示）
- [x] ファイル詳細表示機能

#### 2.9.7 申し込み詳細・削除機能
- [x] 申し込み詳細画面表示機能
- [x] 申し込みデータ削除機能
- [x] 関連ファイル削除機能
- [x] 削除確認ダイアログ機能

#### 2.9.8 モバイル対応・レスポンシブデザイン
- [x] スマートフォン対応レイアウト
- [x] テーブルからカード形式への変換
- [x] 統計情報のレスポンシブ対応
- [x] フィルター部分のモバイル最適化
- [x] タブナビゲーションのモバイル対応

---

## 🎨 Phase 3: UI/UX改善・コード整理（1週間）

### 3.1 CSS統合・整理
- [x] 分散していたCSSの統合
  - [x] ダッシュボード管理画面のCSSを assets/css/admin.css に統合
  - [x] エリア管理画面のCSSを assets/css/admin.css に統合
  - [x] レンタル用品管理画面のCSSを assets/css/admin.css に統合
  - [x] メイン設定画面のCSSを assets/css/admin.css に統合
- [x] 各PHPファイルから`<style>`タグの削除
- [x] 重複CSSの除去
- [x] 一貫性のあるデザインシステムの確立
- [x] 保守性の向上
- [x] パフォーマンスの改善（キャッシュ効率向上）

### 3.2 Contact Form 7料金計算JavaScript統合
- [x] プラグイン対応料金計算JavaScriptの実装
  - [x] 動的エリア料金取得機能（管理画面設定から取得）※既存API活用
  - [x] 動的レンタル用品料金取得機能（管理画面設定から取得）※既存API活用
  - [x] フォームID別の料金設定対応※既存API活用
  - [x] 開催日別の料金設定対応※既存API活用
  - [x] フロントエンド料金計算ロジック（JavaScript実装）
  - [x] 料金計算エンジン※既存MarchePriceCalculator活用
  - [x] エラーハンドリング機能※既存実装活用
- [x] 既存固定料金スクリプトの置き換え
  - [x] ハードコードされた料金の削除
  - [x] プラグインAPI連携への変更
  - [x] 動的料金計算への移行
- [x] フロントエンド統合
  - [x] Contact Form 7フック基盤※既存assets/js/frontend.js活用
  - [x] プラグイン設定との同期機能※既存API活用
  - [x] リアルタイム料金更新機能
  - [x] Stripeボタンテキスト動的更新

---

## 🔧 Phase 4: 管理画面改善・機能拡張（1週間）

### 4.1 管理画面での無効エリア表示機能
- [x] エリア管理で無効化したエリアの管理画面表示対応
  - [x] ダッシュボードの開催日選択で無効エリアも表示
  - [x] エリア管理画面で無効エリアも選択可能
  - [x] フロントエンド（Contact Form 7）では無効エリアを除外
  - [x] 管理画面とフロントエンドの表示制御を分離

#### 4.1.1 データアクセス層の修正
- [x] `MarcheDataAccess`クラスの修正
  - [x] `getAreaOptions`メソッドに`$includeInactive`パラメータ追加
  - [x] 管理画面用とフロントエンド用の取得方法を分離

#### 4.1.2 管理画面の修正
- [x] ダッシュボード管理画面の修正
  - [x] 開催日選択で無効エリアも含めて取得
- [x] エリア管理画面の修正
  - [x] エリア選択で無効エリアも表示

#### 4.1.3 Contact Form 7連携の維持
- [x] フロントエンドでの無効エリア除外を維持
  - [x] `addDynamicOptions`メソッドの修正
  - [x] フロントエンド用の取得方法を明確化
  - [x] 既存の動作に影響がないことを確認

---

**作成日**: 2025年1月
**更新日**: 2025年1月
**バージョン**: 1.4
**作成者**: GITAG
